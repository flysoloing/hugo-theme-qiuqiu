<script>
    //页面流量统计入口
    async function count() {
        //首先获取浏览器当前完整URL和pathname
        const url = window.location.href;
        const pathname = window.location.pathname;
        //console.log('url', url);
        //console.log('pathname', pathname);

        const reqData = buildReqData(url, pathname);
        if(!reqData) {
            return;
        }
        const reqDataStr = JSON.stringify(reqData);
        //console.log('request data', reqData);
        //console.log('request data str', reqDataStr);

        const resData = await req(reqDataStr);
        if(!resData) {
            return null;
        }
        const resDataStr = JSON.stringify(resData);
        //console.log('response data', resData);
        //console.log('response data str', resDataStr);

        if(resData.data && resData.data.sitePV) {
            const code = resData.code;
            //console.log('res code', code);
            const sitePVEl = document.querySelector('#site_pv');
            sitePVEl.innerHTML = resData.data.sitePV;
        }
        if(resData.data && resData.data.pages) {
            if(resData.data.pages.length > 1) {
                const pagePVEls = document.querySelectorAll('.page_pv');
                for(let i = 0; i < pagePVEls.length; i++) {
                    pagePVEls[i].innerHTML = resData.data.pages[i].pagePV;
                }
            }
            if(resData.data.pages.length == 1) {
                const pagePVEl = document.querySelector('.page_pv');
                pagePVEl.innerHTML = resData.data.pages[0].pagePV;
            }
        }
    }

    //根据pathname判断是首页（包括分页），归档页，分类页（包括分类详情页），标签页（包括标签详情页），关于页，简历页还是404页面
    function buildReqData(url, pathname) {
        let reqData = {};
        let urls = [];
        reqData.countType = '10';
        reqData.urls = urls;
        const img404 = document.querySelector('img[alt="404"]');
        if(img404) {
            //reqData.countType = '00';
            //return reqData;
            return null;
        }
        if(pathname === '/' || pathname.includes('/page/')) {
            const aList = Array.prototype.slice.call(document.querySelectorAll('article > div > h1 > a'), 0);
            aList.forEach(el => {
                urls.push(el.href);
            });
            return reqData;
        }
        if(pathname === '/posts/') {
            return reqData;
        }
        if(pathname.includes('/posts/')) {
            urls.push(url);
            reqData.countType = '11';
            return reqData;
        }
        return reqData;
    }

    //发送HTTP请求
    async function req(reqDataStr) {
        const url = 'https://pv.crudman.cn';
        let reqInit = {
            method: 'PUT',
            mode: 'cors',
            cache: 'default',
            referrerPolicy: 'no-referrer-when-downgrade',
            headers: {
                'Content-Type': 'application/json;charset=utf-8',
            },
            body: reqDataStr
        };
        try {
            let response = await fetch(url, reqInit);
            //对应答结果进行判断
            //console.log('response status', response.status);
            //console.log('response statusText',response.statusText);
            if(response.status === 200) {
                return await response.json();
            }
            return null;
        } catch (error) {
            //console.log('put request failed', error);
            return null;
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', count);
    } else {
        count();
    }
</script>